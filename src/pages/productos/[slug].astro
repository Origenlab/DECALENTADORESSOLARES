---
import { getCollection, type CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import Breadcrumb from "../../components/ui/Breadcrumb.astro";
import Button from "../../components/ui/Button.astro";
import Card from "../../components/ui/Card.astro";

interface Props {
  product: CollectionEntry<"productos">;
}

export async function getStaticPaths() {
  const products: CollectionEntry<"productos">[] = await getCollection("productos");

  return products.map((product: CollectionEntry<"productos">) => ({
    params: { slug: product.slug },
    props: { product }
  }));
}

const { product } = Astro.props as Props;
const { Content } = await product.render();

const relatedProducts: CollectionEntry<"productos">[] = (await getCollection("productos"))
  .filter((item: CollectionEntry<"productos">) => item.slug !== product.slug)
  .sort(
    (a: CollectionEntry<"productos">, b: CollectionEntry<"productos">) => a.data.order - b.data.order
  )
  .slice(0, 2);

const faqItems = [
  {
    question: "Este modelo incluye instalacion?",
    answer:
      "El precio del producto es referencial del equipo. La cotizacion final integra instalacion segun condiciones del inmueble y alcance requerido."
  },
  {
    question: "Como se valida si la capacidad es correcta?",
    answer:
      "Se analiza numero de usuarios, puntos de consumo simultaneos y habitos de uso para confirmar cobertura real."
  },
  {
    question: "Cada cuanto se recomienda mantenimiento?",
    answer:
      "En uso residencial normal se recomienda cada 6 a 12 meses. En demanda alta o agua dura puede requerir mayor frecuencia."
  }
];

const productSchema = {
  "@context": "https://schema.org",
  "@type": "Product",
  name: product.data.title,
  description: product.data.description,
  image: `https://decalentadoressolares.com${product.data.image}`,
  brand: {
    "@type": "Brand",
    name: "De Calentadores Solares"
  },
  offers: product.data.price
    ? {
        "@type": "Offer",
        priceCurrency: "MXN",
        price: product.data.price,
        availability: "https://schema.org/InStock"
      }
    : undefined,
  additionalProperty: faqItems.map((item) => ({
    "@type": "PropertyValue",
    name: item.question,
    value: item.answer
  }))
};
---

<BaseLayout
  title={`${product.data.title} | Calentadores Solares`}
  description={product.data.description}
  ogImage={product.data.image}
  schema={productSchema}
>
  <Breadcrumb
    items={[
      { label: "Inicio", href: "/" },
      { label: "Productos", href: "/productos" },
      { label: product.data.title }
    ]}
  />

  <section class="section-tight">
    <div class="product-detail">
      <article class="product-content">
        <img src={product.data.image} alt={product.data.imageAlt} width="960" height="540" loading="eager" />
        <h1>{product.data.title}</h1>
        <p>{product.data.description}</p>
        <Content />
      </article>

      <aside class="product-meta">
        <h2>Ficha tecnica</h2>
        {product.data.price ? (
          <p class="product-meta__price">${product.data.price.toLocaleString("es-MX")} MXN</p>
        ) : (
          <p class="product-meta__price">Cotizacion personalizada</p>
        )}

        <ul class="spec-list">
          {product.data.features.map((feature: string) => (
            <li>{feature}</li>
          ))}
        </ul>

        <Button
          href="https://wa.me/5215512345678?text=Hola,%20quiero%20cotizar%20el%20producto%20que%20vi%20en%20su%20sitio"
          target="_blank"
          rel="noopener noreferrer"
        >
          Solicitar cotizacion de este modelo
        </Button>
        <Button href="/servicios" variant="outline">Ver servicios de instalacion</Button>
        <Button href="/blog" variant="ghost">Leer guias de compra</Button>
      </aside>
    </div>
  </section>

  <section class="section" aria-labelledby="buy-title">
    <header class="section-header">
      <h2 id="buy-title">Antes de comprar este modelo</h2>
      <p class="section-description">
        Validar capacidad y tipo de tecnologia reduce riesgo de mala compra y mejora tu retorno de
        inversion.
      </p>
    </header>

    <div class="process-grid">
      <article class="process-step">
        <span class="step-number">1</span>
        <p>Comparte numero de usuarios y horarios de mayor consumo.</p>
      </article>
      <article class="process-step">
        <span class="step-number">2</span>
        <p>Recibe propuesta con alcance tecnico y costo de instalacion.</p>
      </article>
      <article class="process-step">
        <span class="step-number">3</span>
        <p>Agenda instalacion y plan de mantenimiento preventivo.</p>
      </article>
    </div>
  </section>

  <section class="section" aria-labelledby="product-faq-title">
    <header class="section-header">
      <h2 id="product-faq-title">Preguntas frecuentes de este modelo</h2>
    </header>

    <div class="faq-list">
      {faqItems.map((item) => (
        <details class="faq-item">
          <summary class="faq-question">
            <span>{item.question}</span>
            <span class="faq-icon" aria-hidden="true">+</span>
          </summary>
          <div class="faq-answer">
            <p>{item.answer}</p>
          </div>
        </details>
      ))}
    </div>
  </section>

  <section class="section" aria-labelledby="related-title">
    <header class="section-header">
      <h2 id="related-title">Productos relacionados</h2>
    </header>

    <div class="grid-2-cols">
      {relatedProducts.map((item: CollectionEntry<"productos">) => (
        <Card
          title={item.data.title}
          description={item.data.description}
          image={item.data.image}
          imageAlt={item.data.imageAlt}
          link={`/productos/${item.slug}`}
          variant="compact"
        />
      ))}
    </div>
  </section>
</BaseLayout>
